{% extends 'base.html.twig' %}

{% set currentPath = path(app.request.attributes.get('_route'),
                       app.request.attributes.get('_route_params')) %}

{% block main %}
<section class="parametres">
    <article>
        <h2>Modifier une borne</h2>
        <form action="." class="infos-borne">
				<div class="identification">
                    <div class="champ">
                        {{ form_label(form.emplacement.nom_etablissement, "Nom de l'établissement :") }}
						{{ form_widget(form.emplacement.nom_etablissement) }}
					</div>
					<div class="champ">
                        {{ form_label(form.nom, 'Nom de la borne :') }}
						{{ form_widget(form.nom) }}
					</div>
                    <div class="champ">
                        {{ form_label(form.adresse_mac, 'MAC :') }}
						{{ form_widget(form.adresse_mac) }}
					</div>
					<div class="champ">
                        {{ form_label(form.modeleborne, 'Modèle :') }}
						{{ form_widget(form.modeleborne) }}
					</div>
                    <div class="champ">
                        {{ form_label(form.ssid, 'SSID :') }}
						{{ form_widget(form.ssid) }}
					</div>
				</div>
				<div class="adresse">
                    <div class="champ">
                        {{ form_label(form.emplacement.adresse.numero_rue, 'Numero de rue :') }}
						{{ form_widget(form.emplacement.adresse.numero_rue, {'attr': {'class': 'numero_rue'}}) }}
					</div>
                    <div class="champ">
                        {{ form_label(form.emplacement.adresse.rue, 'Rue :') }}
						{{ form_widget(form.emplacement.adresse.rue, {'attr': {'class': 'rue'}}) }}
					</div>
                    <div class="champ">
                        {{ form_label(form.emplacement.adresse.code_postal, 'CP :') }}
						{{ form_widget(form.emplacement.adresse.code_postal, {'attr': {'class': 'code_postal'}}) }}
					</div>
                    <div class="champ">
                        {{ form_label(form.emplacement.adresse.ville, 'Ville :') }}
						{{ form_widget(form.emplacement.adresse.ville, {'attr': {'class': 'ville'}}) }}
					</div>
                    <div class="champ">
                        {{ form_label(form.emplacement.description, 'Commentaire adresse :') }}
						{{ form_widget(form.emplacement.description) }}
					</div>
                    <span class="button button-alt calculerEmplacement">Calculer l'emplacement <i class="fas fa-map-marked-alt"></i></span>
                    <div class="champ">
                        {{ form_label(form.emplacement.latitude, 'Latitude :') }}
						{{ form_widget(form.emplacement.latitude, {'attr': {'class': 'latitude'}}) }}
					</div>
                    <div class="champ">
                        {{ form_label(form.emplacement.longitude, 'Longitude :') }}
						{{ form_widget(form.emplacement.longitude, {'attr': {'class': 'longitude'}}) }}
					</div>
					{{ form_widget(form.emplacement.adresse.code_postal, {'attr': {'hidden': '', 'value' : 'France','class': 'pays'}}) }}
				</div>
				<div class="submit">
					<input type="submit" name="" class="button button-ok" value="Valider">
					<a href="{{ currentPath }}" class="button button-no">Annuler</a>
				</div>
			</form>
    </article>

    <article>
		<h2>Personalisation du portail</h2>
		<form action="." class="infos-borne">
			<div class="portail">
                <div class="champ">
                    {{ form_label(form.nom_portail, 'Nom du portail :') }}
                    {{ form_widget(form.nom_portail) }}
                </div>
                <div class="champ">
                    {{ form_label(form.img_portail, 'Logo du portail (100ko max) :') }}
                    {{ form_widget(form.img_portail) }}
                </div>
                <div class="champ">
                    {{ form_label(form.desc_portail, 'Description portail (sous-titre) :') }}
                    {{ form_widget(form.desc_portail) }}
                </div>
                <div class="champ">
                    {{ form_label(form.portail_url, 'Redirection après connexion :') }}
                    {{ form_widget(form.portail_url) }}
                </div>
			</div>
            <div class="submit">
                <input type="submit" name="" class="button button-ok" value="Valider">
                {# <input type="submit" name="" class="button button-alt" value="Apliquer à toutes mes bornes"> #}
                <a href="{{ currentPath }}" class="button button-no">Annuler</a>
            </div>
		</form>
	</article>

	<article>
		<h2>Fonctionnement de la borne</h2>
		<form action="." class="fonctionnement-borne">
            <div class="champ">
                {{ form_label(form.quota_user_duree, 'Temps de connexion maximum par jour :') }}
                {{ form_widget(form.quota_user_duree) }}
            </div>
            <div class="champ">
                {{ form_label(form.quota_user_max_bytes, 'Débit maximal par utilisateur (Mb/s) :') }}
                {{ form_widget(form.quota_user_max_bytes) }}
            </div>
			<div class="horaires">
                {{ form_widget(form.Prog_wifi, {'attr': {'class': 'prog_wifi', 'style': 'display:none;'}}) }}
				<span href="." class="ajouter-regle button button-alt">Ajouter une regle</span><br>
				<span>
                    Par défaut la borne fonctionne 24/24h 7/7j. <br>
                    Vous pouvez choisir de ne pas diffuser de wifi entre 00:00 et 23:59 tous les jours de la semaine
                </span>
			</div>
            <div class="submit">
                <input type="submit" name="" class="button button-ok" value="Valider">
                {# <input type="submit" name="" class="button button-alt" value="Apliquer à toutes mes bornes"> #}
                <a href="{{ currentPath }}" class="button button-no">Annuler</a>
            </div>
		</form>
	</article>

    {###################   Reste a faire   #####################}
    {# appliquer a toutes mes bornes #}
{#
	<article>
		<a href="." class="button button-alt">Redémarrer la borne <i class="fas fa-power-off"></i></a>
		<a href="." class="button button-no">Bloquer la borne <i class="fas fa-ban"></i></a>
		<a href="." class="button button-no">Supprimer la borne <i class="fas fa-trash-alt"></i></a>
	</article>
#}
</section>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>

$(document).ready(function(){

    //Gestion du formulaire des horaires

    // On recupere les horaires pour generer le formulaire
    try {
        let baseHoraires = $('.prog_wifi').val();
        let regle;
        baseHoraires = baseHoraires.split(';');

        for (var i = 0; i < baseHoraires.length; i++) {
            regleOff = baseHoraires[i].split(" ");
            regleOn = baseHoraires[i + 1].split(" ");
            if (regleOff[-1] === "off") {
                ajouterRegle(regleOff[4], regleOff[1] + regleOff[0], regleOn[1] + regleOn[0]);
            }
            else {
                continue;
            }
        }
    } catch(e) {
        console.log(e);
    }

    // Rajoute une regle si on clique sur ajouter une regle
	$(".horaires .ajouter-regle").on("click", function() {
        ajouterRegle();
        updateHoraires();
    });

    // Enleve une regle
    $(".horaires").on("click", '.enlever-regle', function() {
        $(this).parent('.champ').remove();
        updateHoraires();
    });

    // Change une regle
    $(".horaires").on("change", 'input, select', function() {
        updateHoraires();
    });

    function updateHoraires() {
        let horaires = "";
        let champ;
        let on;
        let off;
        try {
            for (var i = 0; i < $('.horaires .champ').length; i++) {
                champ = $($('.horaires .champ')[i]);

                off =    champ.children('.debut').val().split(':')[1] + " " +
                        champ.children('.debut').val().split(':')[0] + " " +
                        "* *" + " " +
                        champ.children('.jour').val();

                on =   champ.children('.fin').val().split(':')[1] + " " +
                        champ.children('.fin').val().split(':')[0] + " " +
                        "* *" + " " +
                        champ.children('.jour').val();
                horaires += off + " off ; " + on + " on ; ";
            }

            // Cas des horaires incompatibles
            if((champ.children('.debut').val().split(':')[1] * 60 + champ.children('.debut').val().split(':')[0]) >= (champ.children('.fin').val().split(':')[1] * 60 + champ.children('.fin').val().split(':')[0])) {
                champ.children('.fin').val('23:59');
            }

            // On réécrit le champ
            $('.prog_wifi').val(horaires.trim());
            console.log($('.prog_wifi').val());
        } catch (e) {
            alert('Erreur dans la saisie de la programmation horaire');
            console.log(e);
        }
    }

    function ajouterRegle(jour, debut, fin) {
        let jour_val = jour || "1";
        let debut_val = debut || "18:00";
        let fin_val = fin || "23:59";
        let selected = [];
        selected[jour] = "selected";

        $(".horaires").append($(`
            <div class="champ">
                <span>La borne est éteinte</span>
                <select name="jour" class="jour">
                    <option value="1-7" ${selected["1-7"] || ""}>toute la semaine</option>
                    <option value="1" ${selected["1"] || ""}>le lundi</option>
                    <option value="2" ${selected["2"] || ""}>le mardi</option>
                    <option value="3" ${selected["3"] || ""}>le mercredi</option>
                    <option value="4" ${selected["4"] || ""}>le jeudi</option>
                    <option value="5" ${selected["5"] || ""}>le vendredi</option>
                    <option value="6" ${selected["6"] || ""}>le samedi</option>
                    <option value="7" ${selected["7"] || ""}>le dimanche</option>
                </select>
                <span>entre</span>
                <input type="time" name="start" value="${debut_val}" class="debut">
                <span>et</span>
                <input type="time" name="end" value="${fin_val}"  class="fin">
                <span class="enlever-regle button button-no">Supprimer <i class="fas fa-trash-alt"></i></span>
            </div>
        `));
    }


    // Calcul de la longitude et de la latitude
    $('.calculerEmplacement').on('click', function() {
        var address =   $(".numero_rue").val() + " " +
                        $(".rue").val() + " " +
                        $(".ville").val() + " " +
                        "&postcode=" + $(".code_postal").val();
        $.getJSON(encodeURI("https://api-adresse.data.gouv.fr/search/?q=" + address + "&limit=1"), function(results) {
            if (results.features[0]) {
                $('.longitude').val(results.features[0].geometry.coordinates[0]);
                $('.latitude').val(results.features[0].geometry.coordinates[1]);
            } else {
                alert("Les coordonnées n'ont pas pus être calculés");
            }

        });
    });

});
</script>
{% endblock %}
